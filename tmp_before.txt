<?php $title = $product ? $product['name'] : 'Sản phẩm'; ob_start(); ?>
<?php if (!$product): ?>
  <div class="alert alert-warning">Không tìm thấy sản phẩm.</div>
<?php else: ?>
  <?php
    $pid = (int)$product['id'];
    $pdo = \App\Database::getInstance()->pdo();
    $imgs = $pdo->prepare('SELECT image FROM product_images WHERE product_id = :p ORDER BY sort');
    $imgs->execute([':p'=>$pid]);
    $gallery = $imgs->fetchAll(PDO::FETCH_COLUMN) ?: [];
    $pi = \App\Models\Product::priceInfo($pid); $promo = $pi['promo_price'] ?? null; $hasD = $promo && $promo < (int)$product['price'];
    $attrs = $pdo->prepare('SELECT at.name AS type, a.name AS name FROM product_attributes pa JOIN attributes a ON pa.attribute_id = a.id JOIN attribute_types at ON a.type_id = at.id WHERE pa.product_id = :p ORDER BY at.id, a.id');
    $attrs->execute([':p'=>$pid]);
    $specs = $attrs->fetchAll(PDO::FETCH_ASSOC) ?: [];
  ?>
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm p-3">
        <img id="mainImg" src="<?= htmlspecialchars(($gallery[0] ?? $product['image']) ?: 'assets/images/placeholder.svg') ?>" alt="" style="width:100%; height:360px; object-fit:cover; border-radius:8px;">
        <div class="d-flex gap-2 mt-2" id="thumbs">
          <?php foreach ($gallery as $g): ?>
            <img src="<?= htmlspecialchars($g) ?>" style="width:72px; height:72px; object-fit:cover; border-radius:6px; cursor:pointer; border:1px solid #e9ecef;" onclick="document.getElementById('mainImg').src=this.src;">
          <?php endforeach; ?>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm p-3">
        <h1 class="h4 mb-2"><?= htmlspecialchars($product['name']) ?></h1>
        <?php if ($hasD): ?>
          <div class="mb-2">
            <span class="h3 text-danger fw-bold"><?= number_format((int)$promo,0,',','.') ?>₫</span>
            <span class="ms-2 text-muted text-decoration-line-through"><?= number_format((int)$product['price'],0,',','.') ?>₫</span>
          </div>
        <?php else: ?>
          <div class="h3" style="color:#333; font-weight:700;">
            <?= number_format((int)$product['price'],0,',','.') ?>₫
          </div>
        <?php endif; ?>
        <p class="text-muted"><?= nl2br(htmlspecialchars($product['description'] ?? '')) ?></p>
        <form method="post" action="index.php?action=add_to_cart" class="d-flex align-items-center gap-2">
          <input type="hidden" name="id" value="<?= $pid ?>">
          <label class="form-label mb-0">Số lượng</label>
          <input type="number" name="quantity" value="1" min="1" class="form-control" style="width:120px;">
          <button class="btn btn-primary" type="submit">Thêm vào giỏ</button>
        </form>
      </div>
      <?php if (!empty($specs)): ?>
      <div class="card shadow-sm p-3 mt-3">
        <h2 class="h6">Thông số nổi bật</h2>
        <div class="row">
          <?php foreach ($specs as $s): ?>
            <div class="col-6 mb-2"><strong><?= htmlspecialchars($s['type']) ?>:</strong> <?= htmlspecialchars($s['name']) ?></div>
          <?php endforeach; ?>
        </div>
      </div>
      <?php endif; ?>
    </div>
  </div>
  <?php
    $rs = $pdo->prepare('SELECT rating, comment, created_at FROM ratings WHERE product_id = :p AND approved = 1 ORDER BY id DESC');
    $rs->execute([':p'=>$pid]);
    $ratings = $rs->fetchAll(PDO::FETCH_ASSOC) ?: [];
    $avg = 0; if ($ratings) { $sum=0; foreach ($ratings as $r) $sum += (int)$r['rating']; $avg = round($sum / count($ratings),1); }
  ?>
  <div id="ratings" class="card shadow-sm p-3 mt-3">
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="h6 mb-0">Đánh giá & bình luận</h2>
      <div class="text-muted"><?= $avg ? ("$avg★ / ".count($ratings)." đánh giá") : "Chưa có đánh giá" ?></div>
    </div>
    <hr>
    <?php if (!empty($_SESSION['user_id'])): ?>
      <form method="post" action="index.php?action=product_rate" class="row g-2 mb-3">
        <input type="hidden" name="product_id" value="<?= $pid ?>">
        <div class="col-md-2">
          <select name="rating" class="form-select">
            <?php for($i=5;$i>=1;$i--): ?>
              <option value="<?= $i ?>"><?= $i ?>★</option>
            <?php endfor; ?>
          </select>
        </div>
        <div class="col-md-8"><input name="comment" class="form-control" placeholder="Chia sẻ cảm nhận của bạn"></div>
        <div class="col-md-2"><button class="btn btn-outline-primary w-100">Gửi</button></div>
      </form>
    <?php else: ?>
      <div class="alert alert-info">Bạn cần <a href="index.php?action=login">đăng nhập</a> để đánh giá.</div>
    <?php endif; ?>
    <?php foreach ($ratings as $r): ?>
      <div class="border-bottom py-2">
        <strong><?= (int)$r['rating'] ?>★</strong> - <small class="text-muted"><?= htmlspecialchars($r['created_at']) ?></small>
        <div><?= htmlspecialchars($r['comment'] ?? '') ?></div>
      </div>
    <?php endforeach; ?>
  </div>
<?php endif; ?>
<?php $content = ob_get_clean(); require __DIR__ . '/layout.php'; ?>

